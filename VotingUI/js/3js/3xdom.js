var THREEx=THREEx||{};THREEx.DomEvents=function(a,b){this._camera=a||null,this._domElement=b||document,this._raycaster=new THREE.Raycaster,this._selected=null,this._boundObjs={};var c=this;this._$onClick=function(){c._onClick.apply(c,arguments)},this._$onDblClick=function(){c._onDblClick.apply(c,arguments)},this._$onMouseMove=function(){c._onMouseMove.apply(c,arguments)},this._$onMouseDown=function(){c._onMouseDown.apply(c,arguments)},this._$onMouseUp=function(){c._onMouseUp.apply(c,arguments)},this._$onTouchMove=function(){c._onTouchMove.apply(c,arguments)},this._$onTouchStart=function(){c._onTouchStart.apply(c,arguments)},this._$onTouchEnd=function(){c._onTouchEnd.apply(c,arguments)},this._$onContextmenu=function(){c._onContextmenu.apply(c,arguments)},this._domElement.addEventListener("click",this._$onClick,!1),this._domElement.addEventListener("dblclick",this._$onDblClick,!1),this._domElement.addEventListener("mousemove",this._$onMouseMove,!1),this._domElement.addEventListener("mousedown",this._$onMouseDown,!1),this._domElement.addEventListener("mouseup",this._$onMouseUp,!1),this._domElement.addEventListener("touchmove",this._$onTouchMove,!1),this._domElement.addEventListener("touchstart",this._$onTouchStart,!1),this._domElement.addEventListener("touchend",this._$onTouchEnd,!1),this._domElement.addEventListener("contextmenu",this._$onContextmenu,!1)},THREEx.DomEvents.prototype.destroy=function(){this._domElement.removeEventListener("click",this._$onClick,!1),this._domElement.removeEventListener("dblclick",this._$onDblClick,!1),this._domElement.removeEventListener("mousemove",this._$onMouseMove,!1),this._domElement.removeEventListener("mousedown",this._$onMouseDown,!1),this._domElement.removeEventListener("mouseup",this._$onMouseUp,!1),this._domElement.removeEventListener("touchmove",this._$onTouchMove,!1),this._domElement.removeEventListener("touchstart",this._$onTouchStart,!1),this._domElement.removeEventListener("touchend",this._$onTouchEnd,!1),this._domElement.removeEventListener("contextmenu",this._$onContextmenu,!1)},THREEx.DomEvents.eventNames=["click","dblclick","mouseover","mouseout","mousemove","mousedown","mouseup","contextmenu","touchstart","touchend"],THREEx.DomEvents.prototype._getRelativeMouseXY=function(a){var b=a.target||a.srcElement;3===b.nodeType&&(b=b.parentNode);var c={x:0,y:0},d=b,e=getComputedStyle(d,null);c.y+=parseInt(e.getPropertyValue("padding-top"),10),c.x+=parseInt(e.getPropertyValue("padding-left"),10);do c.x+=d.offsetLeft,c.y+=d.offsetTop,e=getComputedStyle(d,null),c.x+=parseInt(e.getPropertyValue("border-left-width"),10),c.y+=parseInt(e.getPropertyValue("border-top-width"),10);while(d=d.offsetParent);var f={width:b===window?window.innerWidth:b.offsetWidth,height:b===window?window.innerHeight:b.offsetHeight};return{x:2*+((a.pageX-c.x)/f.width)-1,y:2*-((a.pageY-c.y)/f.height)+1}},THREEx.DomEvents.prototype._objectCtxInit=function(a){a._3xDomEvent={}},THREEx.DomEvents.prototype._objectCtxDeinit=function(a){delete a._3xDomEvent},THREEx.DomEvents.prototype._objectCtxIsInit=function(a){return!!a._3xDomEvent},THREEx.DomEvents.prototype._objectCtxGet=function(a){return a._3xDomEvent},THREEx.DomEvents.prototype.camera=function(a){return a&&(this._camera=a),this._camera},THREEx.DomEvents.prototype.bind=function(a,b,c,d){console.assert(THREEx.DomEvents.eventNames.indexOf(b)!==-1,"not available events:"+b),this._objectCtxIsInit(a)||this._objectCtxInit(a);var e=this._objectCtxGet(a);e[b+"Handlers"]||(e[b+"Handlers"]=[]),e[b+"Handlers"].push({callback:c,useCapture:d}),void 0===this._boundObjs[b]&&(this._boundObjs[b]=[]),this._boundObjs[b].push(a)},THREEx.DomEvents.prototype.addEventListener=THREEx.DomEvents.prototype.bind,THREEx.DomEvents.prototype.unbind=function(a,b,c,d){console.assert(THREEx.DomEvents.eventNames.indexOf(b)!==-1,"not available events:"+b),this._objectCtxIsInit(a)||this._objectCtxInit(a);var e=this._objectCtxGet(a);e[b+"Handlers"]||(e[b+"Handlers"]=[]);for(var f=e[b+"Handlers"],g=0;g<f.length;g++){var h=f[g];if(c==h.callback&&d==h.useCapture){f.splice(g,1);break}}var i=this._boundObjs[b].indexOf(a);console.assert(i!==-1),this._boundObjs[b].splice(i,1)},THREEx.DomEvents.prototype.removeEventListener=THREEx.DomEvents.prototype.unbind,THREEx.DomEvents.prototype._bound=function(a,b){var c=this._objectCtxGet(b);return!!c&&!!c[a+"Handlers"]},THREEx.DomEvents.prototype._onMove=function(a,b,c,d){var e=this._boundObjs[a];if(void 0!==e&&0!==e.length){var f=new THREE.Vector2;f.set(b,c),this._raycaster.setFromCamera(f,this._camera);var g=this._raycaster.intersectObjects(e),h=this._selected;if(g.length>0){var i,j,k,l=g[0],m=l.object;this._selected=m,k=this._bound("mousemove",m),h!=m&&(i=this._bound("mouseover",m),j=h&&this._bound("mouseout",h))}else j=h&&this._bound("mouseout",h),this._selected=null;k&&this._notify("mousemove",m,d,l),i&&this._notify("mouseover",m,d,l),j&&this._notify("mouseout",h,d,l)}},THREEx.DomEvents.prototype._onEvent=function(a,b,c,d){var e=this._boundObjs[a];if(void 0!==e&&0!==e.length){var f=new THREE.Vector2;f.set(b,c),this._raycaster.setFromCamera(f,this._camera);var g=this._raycaster.intersectObjects(e,!0);if(0!==g.length){for(var h=g[0],i=h.object,j=this._objectCtxGet(i),k=i.parent;"undefined"==typeof j&&k;)j=this._objectCtxGet(k),k=k.parent;j&&this._notify(a,i,d,h)}}},THREEx.DomEvents.prototype._notify=function(a,b,c,d){var e=this._objectCtxGet(b),f=e?e[a+"Handlers"]:null;if(console.assert(4===arguments.length),!e||!f||0===f.length)return void(b.parent&&this._notify(a,b.parent,c,d));for(var f=e[a+"Handlers"],g=0;g<f.length;g++){var h=f[g],i=!0;h.callback({type:a,target:b,origDomEvent:c,intersect:d,stopPropagation:function(){i=!1}}),i&&h.useCapture===!1&&b.parent&&this._notify(a,b.parent,c,d)}},THREEx.DomEvents.prototype._onMouseDown=function(a){return this._onMouseEvent("mousedown",a)},THREEx.DomEvents.prototype._onMouseUp=function(a){return this._onMouseEvent("mouseup",a)},THREEx.DomEvents.prototype._onMouseEvent=function(a,b){var c=this._getRelativeMouseXY(b);this._onEvent(a,c.x,c.y,b)},THREEx.DomEvents.prototype._onMouseMove=function(a){var b=this._getRelativeMouseXY(a);this._onMove("mousemove",b.x,b.y,a),this._onMove("mouseover",b.x,b.y,a),this._onMove("mouseout",b.x,b.y,a)},THREEx.DomEvents.prototype._onClick=function(a){this._onMouseEvent("click",a)},THREEx.DomEvents.prototype._onDblClick=function(a){this._onMouseEvent("dblclick",a)},THREEx.DomEvents.prototype._onContextmenu=function(a){this._onMouseEvent("contextmenu",a)},THREEx.DomEvents.prototype._onTouchStart=function(a){return this._onTouchEvent("touchstart",a)},THREEx.DomEvents.prototype._onTouchEnd=function(a){return this._onTouchEvent("touchend",a)},THREEx.DomEvents.prototype._onTouchMove=function(a){if(1==a.touches.length){a.preventDefault();var b=2*+(a.touches[0].pageX/window.innerWidth)-1,c=2*-(a.touches[0].pageY/window.innerHeight)+1;this._onMove("mousemove",b,c,a),this._onMove("mouseover",b,c,a),this._onMove("mouseout",b,c,a)}},THREEx.DomEvents.prototype._onTouchEvent=function(a,b){if(1==b.touches.length){b.preventDefault();var c=2*+(b.touches[0].pageX/window.innerWidth)-1,d=2*-(b.touches[0].pageY/window.innerHeight)+1;this._onEvent(a,c,d,b)}};